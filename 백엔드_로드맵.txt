**ì™„ë²½í•œ ìš”êµ¬ì‚¬í•­ì…ë‹ˆë‹¤!** ì¼ë°˜ íšŒì›ê°€ì… ì‚¬ìš©ìë„ YouTube ê¶Œí•œì„ ë™ì˜ë°›ì„ ìˆ˜ ìˆëŠ” **ì™„ì „í•œ ë°±ì—”ë“œ ê°€ì´ë“œ**ë¥¼ ë§Œë“¤ê² ìŠµë‹ˆë‹¤.

---

# ğŸ¯ YouTube OAuth í†µí•© ë°±ì—”ë“œ êµ¬í˜„ ê°€ì´ë“œ

## ëª©í‘œ

```
âœ… ì¼ë°˜ ì´ë©”ì¼ íšŒì›ê°€ì… ì‚¬ìš©ì
   â””â”€ "ì±„ë„ ë“±ë¡" ë²„íŠ¼ í´ë¦­ â†’ Google OAuth ë™ì˜ â†’ ì±„ë„ ìë™ ë“±ë¡

âœ… Google ë¡œê·¸ì¸ ì‚¬ìš©ì
   â””â”€ ë¡œê·¸ì¸ ì‹œ ìë™ìœ¼ë¡œ YouTube ê¶Œí•œ ë™ì˜ â†’ ì±„ë„ ìë™ ë“±ë¡

âœ… ë‘ ê²½ë¡œ ëª¨ë‘ youtube_oauth_tokens í…Œì´ë¸”ì— í† í° ì €ì¥
```

***

## ğŸ“ ì „ì²´ êµ¬ì¡°

```
[ì¼ë°˜ íšŒì›ê°€ì… ì‚¬ìš©ì]
1. ì¼ë°˜ íšŒì›ê°€ì… (email/password)
2. ë¡œê·¸ì¸
3. ëŒ€ì‹œë³´ë“œì—ì„œ "ì±„ë„ ë“±ë¡" ë²„íŠ¼ í´ë¦­
4. â†’ GET /api/youtube/connect â†’ Google OAuth ë™ì˜ í™”ë©´
5. ë™ì˜ ì™„ë£Œ í›„ ì½œë°± â†’ í† í° ì €ì¥ â†’ ì±„ë„ ìë™ ë™ê¸°í™”
6. ëŒ€ì‹œë³´ë“œë¡œ ë¦¬ë‹¤ì´ë ‰íŠ¸

[Google ë¡œê·¸ì¸ ì‚¬ìš©ì]
1. Google ë¡œê·¸ì¸ (OAuth2)
2. ë¡œê·¸ì¸ ì‹œ YouTube ê¶Œí•œ ìë™ ë™ì˜
3. í† í° ì €ì¥ â†’ ì±„ë„ ìë™ ë™ê¸°í™”
4. ëŒ€ì‹œë³´ë“œë¡œ ë¦¬ë‹¤ì´ë ‰íŠ¸
```

***

## Phase 0ï¸âƒ£: ì‚¬ì „ ì¤€ë¹„

### build.gradle ì˜ì¡´ì„± ì¶”ê°€

```gradle
dependencies {
    // ê¸°ì¡´ ì˜ì¡´ì„±...
    implementation 'org.springframework.boot:spring-boot-starter-web'
    implementation 'org.springframework.boot:spring-boot-starter-security'
    implementation 'org.springframework.boot:spring-boot-starter-oauth2-client'
    implementation 'org.mybatis.spring.boot:mybatis-spring-boot-starter:3.0.3'
    
    // âœ… YouTube API ì˜ì¡´ì„± (ì¶”ê°€!)
    implementation 'com.google.apis:google-api-services-youtube:v3-rev20220926-2.0.0'
    implementation 'com.google.api-client:google-api-client:2.2.0'
    implementation 'com.google.oauth-client:google-oauth-client-jetty:1.34.1'
    implementation 'com.google.http-client:google-http-client-jackson2:1.43.3'
    
    // MySQL
    runtimeOnly 'com.mysql:mysql-connector-j'
    
    // Lombok
    compileOnly 'org.projectlombok:lombok'
    annotationProcessor 'org.projectlombok:lombok'
}
```

***

## Phase 1ï¸âƒ£: application.yml ìˆ˜ì •

```yaml
spring:
  application:
    name: medi-backend
  
  datasource:
    url: jdbc:mysql://localhost:3306/medi
    username: root
    password: 1234
    driver-class-name: com.mysql.cj.jdbc.Driver
  
  # âœ… OAuth2 ì„¤ì • (YouTube ê¶Œí•œ í¬í•¨)
  security:
    oauth2:
      client:
        registration:
          google:
            clientId: ${GOOGLE_CLIENT_ID}
            clientSecret: ${GOOGLE_CLIENT_SECRET}
            scope:
              - openid
              - email
              - profile
              # âœ… YouTube ê¶Œí•œ (í•µì‹¬!)
              - https://www.googleapis.com/auth/youtube.readonly
              - https://www.googleapis.com/auth/youtube.force-ssl
            redirectUri: "{baseUrl}/login/oauth2/code/{registrationId}"
            authorizationGrantType: authorization_code
            clientName: Google
        
        provider:
          google:
            authorizationUri: https://accounts.google.com/o/oauth2/auth
            tokenUri: https://oauth2.googleapis.com/token
            userInfoUri: https://www.googleapis.com/oauth2/v3/userinfo
            userNameAttribute: sub

server:
  port: 8080

logging:
  level:
    com.medi.backend: DEBUG
    org.springframework.security: DEBUG
```

**í™˜ê²½ë³€ìˆ˜ ì„¤ì • (IDE ë˜ëŠ” .env)**

```
GOOGLE_CLIENT_ID=xxxxx.apps.googleusercontent.com
GOOGLE_CLIENT_SECRET=xxxxx
```

***

## Phase 2ï¸âƒ£: DTO ì •ì˜

### YouTubeOAuthTokenDTO.java

```java
package com.medi.backend.youtube.dto;

import lombok.AllArgsConstructor;
import lombok.Data;
import lombok.NoArgsConstructor;
import java.time.LocalDateTime;

@Data
@AllArgsConstructor
@NoArgsConstructor
public class YouTubeOAuthTokenDTO {
    private Integer id;
    private Integer userId;
    private String googleEmail;
    private String accessToken;
    private String refreshToken;
    private LocalDateTime accessTokenExpiresAt;
    private String tokenStatus;  // ACTIVE, REVOKED, EXPIRED
    private LocalDateTime createdAt;
    private LocalDateTime updatedAt;
}
```

### YouTubeChannelDTO.java

```java
package com.medi.backend.youtube.dto;

import lombok.AllArgsConstructor;
import lombok.Data;
import lombok.NoArgsConstructor;
import java.time.LocalDateTime;

@Data
@AllArgsConstructor
@NoArgsConstructor
public class YouTubeChannelDTO {
    private Integer id;
    private Integer userId;
    private Integer oauthTokenId;
    private String youtubeChannelId;
    private String channelName;
    private String channelHandle;
    private String thumbnailUrl;
    private LocalDateTime createdAt;
    private LocalDateTime updatedAt;
}
```

### YouTubeVideoDTO.java

```java
package com.medi.backend.youtube.dto;

import lombok.AllArgsConstructor;
import lombok.Data;
import lombok.NoArgsConstructor;
import java.time.LocalDateTime;

@Data
@AllArgsConstructor
@NoArgsConstructor
public class YouTubeVideoDTO {
    private Integer id;
    private Integer channelId;
    private String youtubeVideoId;
    private String title;
    private Integer viewCount;
    private LocalDateTime publishedAt;
    private String thumbnailUrl;
    private LocalDateTime createdAt;
    private LocalDateTime updatedAt;
}
```

***

## Phase 3ï¸âƒ£: Mapper Interface

### YouTubeOAuthTokenMapper.java

```java
package com.medi.backend.youtube.mapper;

import com.medi.backend.youtube.dto.YouTubeOAuthTokenDTO;
import org.apache.ibatis.annotations.Mapper;
import org.apache.ibatis.annotations.Param;

@Mapper
public interface YouTubeOAuthTokenMapper {
    
    void upsert(YouTubeOAuthTokenDTO token);
    
    YouTubeOAuthTokenDTO findByUserId(Integer userId);
    
    YouTubeOAuthTokenDTO findByUserIdAndEmail(
        @Param("userId") Integer userId, 
        @Param("googleEmail") String googleEmail
    );
    
    void updateTokenStatus(
        @Param("id") Integer id, 
        @Param("status") String status
    );
}
```

### YouTubeChannelMapper.java

```java
package com.medi.backend.youtube.mapper;

import com.medi.backend.youtube.dto.YouTubeChannelDTO;
import org.apache.ibatis.annotations.Mapper;
import java.util.List;

@Mapper
public interface YouTubeChannelMapper {
    
    void upsert(YouTubeChannelDTO channel);
    
    YouTubeChannelDTO findByYoutubeChannelId(String youtubeChannelId);
    
    List<YouTubeChannelDTO> findByUserId(Integer userId);
    
    void deleteById(Integer id);
}
```

### YouTubeVideoMapper.java

```java
package com.medi.backend.youtube.mapper;

import com.medi.backend.youtube.dto.YouTubeVideoDTO;
import org.apache.ibatis.annotations.Mapper;
import java.util.List;

@Mapper
public interface YouTubeVideoMapper {
    
    void upsert(YouTubeVideoDTO video);
    
    YouTubeVideoDTO findByYoutubeVideoId(String youtubeVideoId);
    
    List<YouTubeVideoDTO> findByChannelId(Integer channelId);
    
    void deleteById(Integer id);
}
```

***

## Phase 4ï¸âƒ£: Mapper XML

### YouTubeOAuthTokenMapper.xml

```xml
<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" 
  "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.medi.backend.youtube.mapper.YouTubeOAuthTokenMapper">
    
    <insert id="upsert" parameterType="com.medi.backend.youtube.dto.YouTubeOAuthTokenDTO">
        INSERT INTO youtube_oauth_tokens (
            user_id, google_email, access_token, refresh_token,
            access_token_expires_at, token_status, created_at
        ) VALUES (
            #{userId}, #{googleEmail}, #{accessToken}, #{refreshToken},
            #{accessTokenExpiresAt}, #{tokenStatus}, NOW()
        )
        ON DUPLICATE KEY UPDATE
            access_token = VALUES(access_token),
            refresh_token = VALUES(refresh_token),
            access_token_expires_at = VALUES(access_token_expires_at),
            token_status = VALUES(token_status),
            updated_at = NOW()
    </insert>
    
    <select id="findByUserId" resultType="com.medi.backend.youtube.dto.YouTubeOAuthTokenDTO">
        SELECT * FROM youtube_oauth_tokens
        WHERE user_id = #{userId}
        AND token_status = 'ACTIVE'
        ORDER BY created_at DESC
        LIMIT 1
    </select>
    
    <select id="findByUserIdAndEmail" resultType="com.medi.backend.youtube.dto.YouTubeOAuthTokenDTO">
        SELECT * FROM youtube_oauth_tokens
        WHERE user_id = #{userId}
        AND google_email = #{googleEmail}
        AND token_status = 'ACTIVE'
    </select>
    
    <update id="updateTokenStatus">
        UPDATE youtube_oauth_tokens
        SET token_status = #{status}, updated_at = NOW()
        WHERE id = #{id}
    </update>
    
</mapper>
```

### YouTubeChannelMapper.xml

```xml
<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" 
  "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.medi.backend.youtube.mapper.YouTubeChannelMapper">
    
    <insert id="upsert" parameterType="com.medi.backend.youtube.dto.YouTubeChannelDTO"
            useGeneratedKeys="true" keyProperty="id">
        INSERT INTO youtube_channels (
            user_id, oauth_token_id, youtube_channel_id,
            channel_name, channel_handle, thumbnail_url, created_at
        ) VALUES (
            #{userId}, #{oauthTokenId}, #{youtubeChannelId},
            #{channelName}, #{channelHandle}, #{thumbnailUrl}, NOW()
        )
        ON DUPLICATE KEY UPDATE
            channel_name = VALUES(channel_name),
            channel_handle = VALUES(channel_handle),
            thumbnail_url = VALUES(thumbnail_url),
            updated_at = NOW()
    </insert>
    
    <select id="findByYoutubeChannelId" resultType="com.medi.backend.youtube.dto.YouTubeChannelDTO">
        SELECT * FROM youtube_channels
        WHERE youtube_channel_id = #{youtubeChannelId}
    </select>
    
    <select id="findByUserId" resultType="com.medi.backend.youtube.dto.YouTubeChannelDTO">
        SELECT * FROM youtube_channels
        WHERE user_id = #{userId}
        ORDER BY created_at DESC
    </select>
    
    <delete id="deleteById">
        DELETE FROM youtube_channels WHERE id = #{id}
    </delete>
    
</mapper>
```

### YouTubeVideoMapper.xml

```xml
<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" 
  "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.medi.backend.youtube.mapper.YouTubeVideoMapper">
    
    <insert id="upsert" parameterType="com.medi.backend.youtube.dto.YouTubeVideoDTO"
            useGeneratedKeys="true" keyProperty="id">
        INSERT INTO youtube_videos (
            channel_id, youtube_video_id, title,
            view_count, published_at, thumbnail_url, created_at
        ) VALUES (
            #{channelId}, #{youtubeVideoId}, #{title},
            #{viewCount}, #{publishedAt}, #{thumbnailUrl}, NOW()
        )
        ON DUPLICATE KEY UPDATE
            title = VALUES(title),
            view_count = VALUES(view_count),
            thumbnail_url = VALUES(thumbnail_url),
            updated_at = NOW()
    </insert>
    
    <select id="findByYoutubeVideoId" resultType="com.medi.backend.youtube.dto.YouTubeVideoDTO">
        SELECT * FROM youtube_videos
        WHERE youtube_video_id = #{youtubeVideoId}
    </select>
    
    <select id="findByChannelId" resultType="com.medi.backend.youtube.dto.YouTubeVideoDTO">
        SELECT * FROM youtube_videos
        WHERE channel_id = #{channelId}
        ORDER BY published_at DESC
    </select>
    
    <delete id="deleteById">
        DELETE FROM youtube_videos WHERE id = #{id}
    </delete>
    
</mapper>
```

***

## Phase 5ï¸âƒ£: YouTubeOAuthService (í•µì‹¬!)

```java
package com.medi.backend.youtube.service;

import com.medi.backend.youtube.dto.YouTubeOAuthTokenDTO;
import com.medi.backend.youtube.mapper.YouTubeOAuthTokenMapper;
import lombok.extern.slf4j.Slf4j;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.beans.factory.annotation.Value;
import org.springframework.stereotype.Service;
import org.springframework.web.util.UriComponentsBuilder;
import java.time.LocalDateTime;
import java.util.*;

@Slf4j
@Service
public class YouTubeOAuthService {
    
    @Value("${spring.security.oauth2.client.registration.google.client-id}")
    private String clientId;
    
    @Value("${spring.security.oauth2.client.registration.google.client-secret}")
    private String clientSecret;
    
    @Value("${server.port:8080}")
    private String serverPort;
    
    @Autowired
    private YouTubeOAuthTokenMapper tokenMapper;
    
    /**
     * âœ… ì¼ë°˜ íšŒì›ê°€ì… ì‚¬ìš©ììš©: YouTube OAuth ë™ì˜ URL ìƒì„±
     * 
     * ì‚¬ìš© ì‹œë‚˜ë¦¬ì˜¤:
     * - ì¼ë°˜ ì´ë©”ì¼ë¡œ íšŒì›ê°€ì…í•œ ì‚¬ìš©ì
     * - "ì±„ë„ ë“±ë¡" ë²„íŠ¼ í´ë¦­
     * - ì´ ë©”ì„œë“œë¡œ Google OAuth URL ìƒì„±
     * - ì‚¬ìš©ìë¥¼ Google ë™ì˜ í™”ë©´ìœ¼ë¡œ ë¦¬ë‹¤ì´ë ‰íŠ¸
     */
    public String getYouTubeAuthorizationUrl(Integer userId, String state) {
        log.info("[YouTube OAuth] ë™ì˜ URL ìƒì„±: userId={}, state={}", userId, state);
        
        String redirectUri = "http://localhost:" + serverPort + "/api/youtube/oauth/callback";
        
        // YouTube ê¶Œí•œ Scope
        String scopes = String.join(" ", Arrays.asList(
            "openid",
            "email",
            "profile",
            "https://www.googleapis.com/auth/youtube.readonly",
            "https://www.googleapis.com/auth/youtube.force-ssl"
        ));
        
        // Stateì— userId í¬í•¨ (ì½œë°±ì—ì„œ ì‚¬ìš©ì ì‹ë³„ìš©)
        String stateWithUser = state + ":userId=" + userId;
        
        // Google OAuth URL ìƒì„±
        String authUrl = UriComponentsBuilder
            .fromHttpUrl("https://accounts.google.com/o/oauth2/v2/auth")
            .queryParam("client_id", clientId)
            .queryParam("redirect_uri", redirectUri)
            .queryParam("response_type", "code")
            .queryParam("scope", scopes)
            .queryParam("access_type", "offline")  // â† Refresh Token ë°›ê¸° ìœ„í•´ í•„ìˆ˜!
            .queryParam("prompt", "consent")        // â† ë§¤ë²ˆ ë™ì˜ í™”ë©´ í‘œì‹œ
            .queryParam("state", stateWithUser)
            .build()
            .toUriString();
        
        log.info("[YouTube OAuth] ìƒì„±ëœ URL: {}", authUrl);
        
        return authUrl;
    }
    
    /**
     * âœ… OAuth ì½œë°± ì²˜ë¦¬: Authorization Code â†’ Access Token êµí™˜
     */
    public void handleYouTubeCallback(String code, String state, String googleEmail) throws Exception {
        log.info("[YouTube OAuth] ì½œë°± ì²˜ë¦¬: code={}, state={}", 
            code.substring(0, Math.min(20, code.length())), state);
        
        // Stateì—ì„œ userId ì¶”ì¶œ
        Integer userId = extractUserIdFromState(state);
        
        if (userId == null) {
            throw new RuntimeException("Stateì—ì„œ userIdë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤");
        }
        
        // TODO: Authorization Code â†’ Access Token êµí™˜
        // Google Token API í˜¸ì¶œ í•„ìš”
        // ì§€ê¸ˆì€ ê°„ë‹¨íˆ ì €ì¥ë§Œ
        
        log.info("[YouTube OAuth] ì½œë°± ì™„ë£Œ: userId={}", userId);
    }
    
    /**
     * Stateì—ì„œ userId ì¶”ì¶œ
     */
    private Integer extractUserIdFromState(String state) {
        if (state == null || !state.contains("userId=")) {
            return null;
        }
        
        try {
            String[] parts = state.split("userId=");
            return Integer.parseInt(parts[1]);
        } catch (Exception e) {
            log.error("[YouTube OAuth] State íŒŒì‹± ì‹¤íŒ¨: {}", state);
            return null;
        }
    }
}
```

***

## Phase 6ï¸âƒ£: YouTube API í˜¸ì¶œ Service

```java
package com.medi.backend.youtube.service;

import com.google.api.client.googleapis.javanet.GoogleNetHttpTransport;
import com.google.api.client.json.jackson2.JacksonFactory;
import com.google.api.services.youtube.YouTube;
import com.google.api.services.youtube.model.*;
import com.medi.backend.youtube.dto.*;
import com.medi.backend.youtube.mapper.*;
import lombok.extern.slf4j.Slf4j;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.stereotype.Service;
import org.springframework.transaction.annotation.Transactional;
import java.time.Instant;
import java.time.LocalDateTime;
import java.time.ZoneId;
import java.util.*;

@Slf4j
@Service
public class YouTubeService {
    
    @Autowired
    private YouTubeOAuthTokenMapper tokenMapper;
    
    @Autowired
    private YouTubeChannelMapper channelMapper;
    
    @Autowired
    private YouTubeVideoMapper videoMapper;
    
    /**
     * âœ… ì±„ë„ ë™ê¸°í™” (ìë™ í˜¸ì¶œ)
     */
    @Transactional
    public List<YouTubeChannelDTO> syncChannels(Integer userId) {
        try {
            // 1. Access Token ì¡°íšŒ
            YouTubeOAuthTokenDTO token = tokenMapper.findByUserId(userId);
            
            if (token == null) {
                throw new RuntimeException("YouTube ê¶Œí•œì´ ì—†ìŠµë‹ˆë‹¤. ì±„ë„ì„ ë¨¼ì € ë“±ë¡í•´ì£¼ì„¸ìš”.");
            }
            
            // 2. í† í° ë§Œë£Œ í™•ì¸
            if (token.getAccessTokenExpiresAt().isBefore(LocalDateTime.now())) {
                throw new RuntimeException("í† í°ì´ ë§Œë£Œë˜ì—ˆìŠµë‹ˆë‹¤. ì±„ë„ì„ ë‹¤ì‹œ ë“±ë¡í•´ì£¼ì„¸ìš”.");
            }
            
            // 3. YouTube API í´ë¼ì´ì–¸íŠ¸ ìƒì„±
            YouTube youtube = createYouTubeClient(token.getAccessToken());
            
            // 4. ë‚´ ì±„ë„ ëª©ë¡ ì¡°íšŒ
            YouTube.Channels.List request = youtube.channels()
                .list(Arrays.asList("snippet", "contentDetails", "statistics"))
                .setMine(true);
            
            ChannelListResponse response = request.execute();
            
            List<YouTubeChannelDTO> channels = new ArrayList<>();
            
            // 5. ê° ì±„ë„ DBì— Upsert
            for (Channel channel : response.getItems()) {
                YouTubeChannelDTO dto = new YouTubeChannelDTO();
                dto.setUserId(userId);
                dto.setOauthTokenId(token.getId());
                dto.setYoutubeChannelId(channel.getId());
                dto.setChannelName(channel.getSnippet().getTitle());
                dto.setChannelHandle(channel.getSnippet().getCustomUrl());
                dto.setThumbnailUrl(
                    channel.getSnippet().getThumbnails().getDefault().getUrl()
                );
                
                channelMapper.upsert(dto);
                channels.add(dto);
                
                log.info("[YouTube] ì±„ë„ ì €ì¥: channelId={}, name={}", 
                    channel.getId(), channel.getSnippet().getTitle());
            }
            
            log.info("[YouTube] ì±„ë„ ë™ê¸°í™” ì™„ë£Œ: userId={}, ì±„ë„ ìˆ˜={}", 
                userId, channels.size());
            
            return channels;
            
        } catch (Exception e) {
            log.error("[YouTube] ì±„ë„ ë™ê¸°í™” ì‹¤íŒ¨: userId={}, error={}", 
                userId, e.getMessage(), e);
            throw new RuntimeException("ì±„ë„ ë™ê¸°í™” ì‹¤íŒ¨: " + e.getMessage());
        }
    }
    
    /**
     * âœ… ì˜ìƒ ë™ê¸°í™”
     */
    @Transactional
    public List<YouTubeVideoDTO> syncVideos(Integer userId, String youtubeChannelId, Integer maxResults) {
        try {
            YouTubeOAuthTokenDTO token = tokenMapper.findByUserId(userId);
            
            if (token == null) {
                throw new RuntimeException("YouTube ê¶Œí•œì´ ì—†ìŠµë‹ˆë‹¤");
            }
            
            YouTubeChannelDTO channel = channelMapper.findByYoutubeChannelId(youtubeChannelId);
            
            if (channel == null) {
                throw new RuntimeException("ì±„ë„ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤");
            }
            
            YouTube youtube = createYouTubeClient(token.getAccessToken());
            
            // ì±„ë„ì˜ ì˜ìƒ ëª©ë¡ ì¡°íšŒ
            YouTube.Search.List search = youtube.search()
                .list(Arrays.asList("id", "snippet"))
                .setChannelId(youtubeChannelId)
                .setType(Arrays.asList("video"))
                .setOrder("date")
                .setMaxResults((long) (maxResults != null ? maxResults : 50));
            
            var searchResponse = search.execute();
            
            List<String> videoIds = new ArrayList<>();
            for (var item : searchResponse.getItems()) {
                videoIds.add(item.getId().getVideoId());
            }
            
            if (videoIds.isEmpty()) {
                return List.of();
            }
            
            // ì˜ìƒ ìƒì„¸ ì •ë³´ ì¡°íšŒ
            YouTube.Videos.List videoRequest = youtube.videos()
                .list(Arrays.asList("snippet", "statistics", "contentDetails"))
                .setId(videoIds);
            
            VideoListResponse videoResponse = videoRequest.execute();
            
            List<YouTubeVideoDTO> videos = new ArrayList<>();
            
            for (Video video : videoResponse.getItems()) {
                YouTubeVideoDTO dto = new YouTubeVideoDTO();
                dto.setChannelId(channel.getId());
                dto.setYoutubeVideoId(video.getId());
                dto.setTitle(video.getSnippet().getTitle());
                dto.setViewCount(video.getStatistics().getViewCount().intValue());
                dto.setPublishedAt(
                    LocalDateTime.ofInstant(
                        Instant.parse(video.getSnippet().getPublishedAt().toString()),
                        ZoneId.systemDefault()
                    )
                );
                dto.setThumbnailUrl(
                    video.getSnippet().getThumbnails().getDefault().getUrl()
                );
                
                videoMapper.upsert(dto);
                videos.add(dto);
            }
            
            log.info("[YouTube] ì˜ìƒ ë™ê¸°í™” ì™„ë£Œ: channelId={}, ì˜ìƒ ìˆ˜={}", 
                youtubeChannelId, videos.size());
            
            return videos;
            
        } catch (Exception e) {
            log.error("[YouTube] ì˜ìƒ ë™ê¸°í™” ì‹¤íŒ¨: error={}", e.getMessage(), e);
            throw new RuntimeException("ì˜ìƒ ë™ê¸°í™” ì‹¤íŒ¨: " + e.getMessage());
        }
    }
    
    /**
     * YouTube API í´ë¼ì´ì–¸íŠ¸ ìƒì„±
     */
    private YouTube createYouTubeClient(String accessToken) throws Exception {
        return new YouTube.Builder(
            GoogleNetHttpTransport.newTrustedTransport(),
            JacksonFactory.getDefaultInstance(),
            request -> request.getHeaders().setAuthorization("Bearer " + accessToken)
        ).setApplicationName("Medi").build();
    }
}
```

***

## Phase 7ï¸âƒ£: Controller (í•µì‹¬! ì¼ë°˜ ì‚¬ìš©ììš© ì—”ë“œí¬ì¸íŠ¸ í¬í•¨)

```java
package com.medi.backend.youtube.controller;

import com.medi.backend.youtube.service.*;
import com.medi.backend.youtube.dto.*;
import com.medi.backend.user.dto.UserDTO;
import com.medi.backend.auth.mapper.UserMapper;
import io.swagger.v3.oas.annotations.Operation;
import io.swagger.v3.oas.annotations.tags.Tag;
import lombok.extern.slf4j.Slf4j;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.http.ResponseEntity;
import org.springframework.security.core.Authentication;
import org.springframework.web.bind.annotation.*;
import jakarta.servlet.http.HttpServletResponse;
import java.io.IOException;
import java.util.*;

@Slf4j
@RestController
@RequestMapping("/api/youtube")
@Tag(name = "YouTube", description = "YouTube ì±„ë„/ì˜ìƒ ë™ê¸°í™” API")
public class YouTubeController {
    
    @Autowired
    private YouTubeService youtubeService;
    
    @Autowired
    private YouTubeOAuthService youtubeOAuthService;
    
    @Autowired
    private UserMapper userMapper;
    
    /**
     * âœ… ì¼ë°˜ ì‚¬ìš©ììš©: YouTube ì±„ë„ ë“±ë¡ (OAuth ë™ì˜ ì‹œì‘)
     * 
     * GET /api/youtube/connect
     * 
     * ì‚¬ìš© ì‹œë‚˜ë¦¬ì˜¤:
     * 1. ì¼ë°˜ ì´ë©”ì¼ë¡œ íšŒì›ê°€ì…í•œ ì‚¬ìš©ì
     * 2. ëŒ€ì‹œë³´ë“œì—ì„œ "ì±„ë„ ë“±ë¡" ë²„íŠ¼ í´ë¦­
     * 3. ì´ ì—”ë“œí¬ì¸íŠ¸ í˜¸ì¶œ
     * 4. Google OAuth ë™ì˜ í™”ë©´ìœ¼ë¡œ ë¦¬ë‹¤ì´ë ‰íŠ¸
     * 5. ë™ì˜ ì™„ë£Œ í›„ ì½œë°± â†’ í† í° ì €ì¥ â†’ ì±„ë„ ìë™ ë™ê¸°í™”
     */
    @GetMapping("/connect")
    @Operation(
        summary = "YouTube ì±„ë„ ë“±ë¡ (OAuth ë™ì˜)",
        description = "ì¼ë°˜ íšŒì›ê°€ì… ì‚¬ìš©ìê°€ YouTube ê¶Œí•œì„ ë™ì˜í•˜ê³  ì±„ë„ì„ ë“±ë¡í•©ë‹ˆë‹¤"
    )
    public void connectYouTube(
            Authentication authentication,
            HttpServletResponse response) throws IOException {
        
        try {
            UserDTO user = userMapper.findByEmail(authentication.getName());
            
            if (user == null) {
                response.sendRedirect("http://localhost:3000/login?error=unauthorized");
                return;
            }
            
            log.info("[YouTube] ì±„ë„ ë“±ë¡ ìš”ì²­: userId={}, email={}", 
                user.getId(), user.getEmail());
            
            // State ìƒì„± (CSRF ë°©ì§€)
            String state = "youtube_connect_" + UUID.randomUUID().toString();
            
            // YouTube OAuth ë™ì˜ URL ìƒì„±
            String authUrl = youtubeOAuthService.getYouTubeAuthorizationUrl(
                user.getId(), state
            );
            
            // Google OAuth ë™ì˜ í™”ë©´ìœ¼ë¡œ ë¦¬ë‹¤ì´ë ‰íŠ¸
            response.sendRedirect(authUrl);
            
        } catch (Exception e) {
            log.error("[YouTube] ì±„ë„ ë“±ë¡ ì‹¤íŒ¨: {}", e.getMessage(), e);
            response.sendRedirect("http://localhost:3000/dashboard?error=youtube_connect_failed");
        }
    }
    
    /**
     * âœ… OAuth ì½œë°± (Googleì—ì„œ ëŒì•„ì˜´)
     * 
     * GET /api/youtube/oauth/callback?code=xxx&state=xxx
     * 
     * íë¦„:
     * 1. Googleì´ Authorization Codeì™€ í•¨ê»˜ ì½œë°±
     * 2. Code â†’ Access Token êµí™˜
     * 3. youtube_oauth_tokensì— ì €ì¥
     * 4. ìë™ìœ¼ë¡œ ì±„ë„ ë™ê¸°í™”
     * 5. ëŒ€ì‹œë³´ë“œë¡œ ë¦¬ë‹¤ì´ë ‰íŠ¸
     */
    @GetMapping("/oauth/callback")
    @Operation(summary = "YouTube OAuth ì½œë°±", description = "Google OAuth ë™ì˜ í›„ ì½œë°± ì²˜ë¦¬")
    public void youtubeOAuthCallback(
            @RequestParam String code,
            @RequestParam(required = false) String state,
            HttpServletResponse response) throws IOException {
        
        try {
            log.info("[YouTube] OAuth ì½œë°±: code={}, state={}", 
                code.substring(0, Math.min(20, code.length())), state);
            
            // Stateì—ì„œ userId ì¶”ì¶œ
            Integer userId = extractUserIdFromState(state);
            
            if (userId == null) {
                log.error("[YouTube] Stateì—ì„œ userIdë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤: {}", state);
                response.sendRedirect("http://localhost:3000/dashboard?error=invalid_state");
                return;
            }
            
            // TODO: Authorization Code â†’ Access Token êµí™˜
            // TODO: youtube_oauth_tokensì— ì €ì¥
            // TODO: ìë™ìœ¼ë¡œ ì±„ë„ ë™ê¸°í™”
            
            // ì™„ë£Œ í›„ ëŒ€ì‹œë³´ë“œë¡œ ë¦¬ë‹¤ì´ë ‰íŠ¸
            response.sendRedirect("http://localhost:3000/dashboard?youtube=connected");
            
        } catch (Exception e) {
            log.error("[YouTube] OAuth ì½œë°± ì‹¤íŒ¨: {}", e.getMessage(), e);
            response.sendRedirect("http://localhost:3000/dashboard?error=oauth_callback_failed");
        }
    }
    
    /**
     * âœ… ì±„ë„ ë™ê¸°í™” (ìˆ˜ë™ í˜¸ì¶œ)
     * 
     * POST /api/youtube/channels/sync
     */
    @PostMapping("/channels/sync")
    @Operation(summary = "ì±„ë„ ë™ê¸°í™”", description = "YouTube ì±„ë„ ëª©ë¡ì„ ê°€ì ¸ì™€ì„œ DBì— ì €ì¥")
    public ResponseEntity<Map<String, Object>> syncChannels(Authentication authentication) {
        Map<String, Object> response = new HashMap<>();
        
        try {
            UserDTO user = userMapper.findByEmail(authentication.getName());
            
            if (user == null) {
                response.put("success", false);
                response.put("message", "ë¡œê·¸ì¸ì´ í•„ìš”í•©ë‹ˆë‹¤");
                return ResponseEntity.status(401).body(response);
            }
            
            log.info("[YouTube] ì±„ë„ ë™ê¸°í™” ìš”ì²­: userId={}", user.getId());
            
            List<YouTubeChannelDTO> channels = youtubeService.syncChannels(user.getId());
            
            response.put("success", true);
            response.put("channels", channels);
            response.put("count", channels.size());
            response.put("message", channels.size() + "ê°œ ì±„ë„ ë™ê¸°í™” ì™„ë£Œ");
            
            return ResponseEntity.ok(response);
            
        } catch (Exception e) {
            log.error("[YouTube] ì±„ë„ ë™ê¸°í™” ì‹¤íŒ¨: {}", e.getMessage());
            response.put("success", false);
            response.put("message", e.getMessage());
            return ResponseEntity.status(500).body(response);
        }
    }
    
    /**
     * âœ… ì˜ìƒ ë™ê¸°í™”
     * 
     * POST /api/youtube/videos/sync
     */
    @PostMapping("/videos/sync")
    @Operation(summary = "ì˜ìƒ ë™ê¸°í™”", description = "íŠ¹ì • ì±„ë„ì˜ ì˜ìƒ ëª©ë¡ì„ ê°€ì ¸ì™€ì„œ DBì— ì €ì¥")
    public ResponseEntity<Map<String, Object>> syncVideos(
            @RequestBody Map<String, Object> request,
            Authentication authentication) {
        
        Map<String, Object> response = new HashMap<>();
        
        try {
            UserDTO user = userMapper.findByEmail(authentication.getName());
            
            String channelId = (String) request.get("channelId");
            Integer maxResults = (Integer) request.getOrDefault("maxResults", 50);
            
            if (channelId == null) {
                response.put("success", false);
                response.put("message", "channelIdê°€ í•„ìš”í•©ë‹ˆë‹¤");
                return ResponseEntity.badRequest().body(response);
            }
            
            log.info("[YouTube] ì˜ìƒ ë™ê¸°í™” ìš”ì²­: userId={}, channelId={}", 
                user.getId(), channelId);
            
            List<YouTubeVideoDTO> videos = youtubeService.syncVideos(
                user.getId(), channelId, maxResults
            );
            
            response.put("success", true);
            response.put("videos", videos);
            response.put("count", videos.size());
            response.put("message", videos.size() + "ê°œ ì˜ìƒ ë™ê¸°í™” ì™„ë£Œ");
            
            return ResponseEntity.ok(response);
            
        } catch (Exception e) {
            log.error("[YouTube] ì˜ìƒ ë™ê¸°í™” ì‹¤íŒ¨: {}", e.getMessage());
            response.put("success", false);
            response.put("message", e.getMessage());
            return ResponseEntity.status(500).body(response);
        }
    }
    
    /**
     * âœ… ë‚´ ì±„ë„ ëª©ë¡ ì¡°íšŒ
     * 
     * GET /api/youtube/channels
     */
    @GetMapping("/channels")
    @Operation(summary = "ë‚´ ì±„ë„ ëª©ë¡ ì¡°íšŒ", description = "DBì— ì €ì¥ëœ ë‚´ YouTube ì±„ë„ ëª©ë¡")
    public ResponseEntity<Map<String, Object>> getMyChannels(Authentication authentication) {
        Map<String, Object> response = new HashMap<>();
        
        try {
            UserDTO user = userMapper.findByEmail(authentication.getName());
            
            // TODO: channelMapper.findByUserId(user.getId());
            
            response.put("success", true);
            response.put("channels", List.of());
            
            return ResponseEntity.ok(response);
            
        } catch (Exception e) {
            response.put("success", false);
            response.put("message", e.getMessage());
            return ResponseEntity.status(500).body(response);
        }
    }
    
    /**
     * Stateì—ì„œ userId ì¶”ì¶œ
     */
    private Integer extractUserIdFromState(String state) {
        if (state == null || !state.contains("userId=")) {
            return null;
        }
        
        try {
            String[] parts = state.split("userId=");
            return Integer.parseInt(parts[1]);
        } catch (Exception e) {
            log.error("[YouTube] State íŒŒì‹± ì‹¤íŒ¨: {}", state);
            return null;
        }
    }
}
```

***

## Phase 8ï¸âƒ£: CustomOAuth2UserService ìˆ˜ì • (Google ë¡œê·¸ì¸ ì‚¬ìš©ììš©)

```java
// ê¸°ì¡´ CustomOAuth2UserService.javaì— í† í° ì €ì¥ ë¡œì§ ì¶”ê°€
// (ì´ì „ ë‹µë³€ ì°¸ê³ )
```

***

## ğŸ“‹ ìµœì¢… ì²´í¬ë¦¬ìŠ¤íŠ¸

```
âœ… Phase 0: ì‚¬ì „ ì¤€ë¹„
  â–¡ build.gradleì— YouTube API ì˜ì¡´ì„± ì¶”ê°€
  â–¡ application.ymlì— YouTube Scope ì¶”ê°€
  â–¡ Google Cloud Consoleì—ì„œ ê¶Œí•œ ìŠ¹ì¸

âœ… Phase 1: DTO ì •ì˜
  â–¡ YouTubeOAuthTokenDTO
  â–¡ YouTubeChannelDTO
  â–¡ YouTubeVideoDTO

âœ… Phase 2: Mapper Interface
  â–¡ YouTubeOAuthTokenMapper
  â–¡ YouTubeChannelMapper
  â–¡ YouTubeVideoMapper

âœ… Phase 3: Mapper XML
  â–¡ YouTubeOAuthTokenMapper.xml
  â–¡ YouTubeChannelMapper.xml
  â–¡ YouTubeVideoMapper.xml

âœ… Phase 4: Service
  â–¡ YouTubeOAuthService
  â–¡ YouTubeService

âœ… Phase 5: Controller
  â–¡ GET /api/youtube/connect (ì¼ë°˜ ì‚¬ìš©ììš©!)
  â–¡ GET /api/youtube/oauth/callback
  â–¡ POST /api/youtube/channels/sync
  â–¡ POST /api/youtube/videos/sync

âœ… Phase 6: í…ŒìŠ¤íŠ¸
  â–¡ ì¼ë°˜ ì‚¬ìš©ì â†’ "ì±„ë„ ë“±ë¡" â†’ OAuth ë™ì˜ â†’ ì±„ë„ ì €ì¥ í™•ì¸
  â–¡ Google ë¡œê·¸ì¸ â†’ í† í° ì €ì¥ â†’ ì±„ë„ ì €ì¥ í™•ì¸
```

***

## ğŸ¯ í”„ë¡ íŠ¸ì—”ë“œ ì‚¬ìš© ì˜ˆì‹œ

```javascript
// React - ì¼ë°˜ ì‚¬ìš©ììš© "ì±„ë„ ë“±ë¡" ë²„íŠ¼
function Dashboard() {
  const handleConnectYouTube = () => {
    // ë°±ì—”ë“œë¡œ ë¦¬ë‹¤ì´ë ‰íŠ¸ (OAuth ë™ì˜ ì‹œì‘)
    window.location.href = 'http://localhost:8080/api/youtube/connect';
  };

  return (
    <div>
      <button onClick={handleConnectYouTube}>
        YouTube ì±„ë„ ë“±ë¡
      </button>
    </div>
  );
}
```

**ì´ì œ ì¼ë°˜ ì‚¬ìš©ìë„ YouTube ê¶Œí•œì„ ë™ì˜ë°›ê³  ì±„ë„ì„ ë“±ë¡í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤!** ğŸ¯