<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.medi.backend.auth.mapper.AuthMapper">
    
    <!-- ResultMap: DB 컬럼명 → DTO 필드명 매핑 -->
    <resultMap id="EmailVerificationResultMap" type="com.medi.backend.auth.dto.EmailVerification">
        <id property="id" column="id"/>
        <result property="email" column="email"/>
        <result property="code" column="code"/>
        <result property="expiresAt" column="expires_at"/>
        <result property="createdAt" column="created_at"/>
    </resultMap>
    
    <!-- 인증 코드 저장 -->
    <insert id="insertVerification">
        INSERT INTO email_verifications (email, code, expires_at)
        VALUES (#{email}, #{code}, #{expiresAt})
    </insert>
    
    <!-- 이메일과 코드로 조회 (만료되지 않은 것만) -->
    <select id="findByEmailAndCode" resultMap="EmailVerificationResultMap">
        <![CDATA[
        SELECT id, email, code, expires_at, created_at
        FROM email_verifications
        WHERE email = #{email} 
        AND code = #{code}
        AND expires_at > NOW()
        LIMIT 1
        ]]>
    </select>
    
    <!-- 이메일 기존 인증 코드 삭제 (재인증을 위해서 ) -->
    <delete id="deleteByEmail">
        DELETE FROM email_verifications WHERE email = #{email}
    </delete>
    
</mapper>
