<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper
        PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.medi.backend.agent.mapper.AgentMapper">

    <select id="findVideoIdByYoutubeVideoId" resultType="java.lang.Integer">
        SELECT id 
        FROM youtube_videos
        WHERE youtube_video_id = #{youtubeVideoId} 
        LIMIT 1
    </select>

    <insert id="insertFilteredComment">
        INSERT INTO youtube_comments (
            video_id,
            youtube_comment_id,
            comment_text,
            commenter_name,
            published_at,
            like_count
        ) VALUES (
            #{videoId},
            #{youtubeCommentId},
            #{commentText},
            #{commenterName},
            STR_TO_DATE(#{publishedAt}, '%Y-%m-%dT%H:%i:%s.%fZ'),
            #{likeCount}
        )
        ON DUPLICATE KEY UPDATE
            comment_text = VALUES(comment_text),
            commenter_name = VALUES(commenter_name),
            published_at = VALUES(published_at),
            like_count = VALUES(like_count)
    </insert>

    <select id="findCommentIdByYoutubeCommentId" resultType="java.lang.Integer">
        SELECT id 
        FROM youtube_comments
        WHERE youtube_comment_id = #{youtubeCommentId}
        LIMIT 1
    </select>

    <insert id="insertCommentAnalysisResult">
        INSERT INTO ai_comment_analysis_result (
            youtube_comment_id,
            status,
            reason,
            analyzed_at,
            harmfulness_level,
            detection_source
        ) VALUES (
            #{youtubeCommentId},
            #{status},
            <choose>
                <when test="reason != null and reason != ''">
                    #{reason}
                </when>
                <otherwise>
                    NULL
                </otherwise>
            </choose>,
            <choose>
                <when test="analyzedAt != null">
                    STR_TO_DATE(#{analyzedAt}, '%Y-%m-%dT%H:%i:%s.%f')
                </when>
                <otherwise>
                    NOW()
                </otherwise>
            </choose>,
            'MEDIUM',
            'AI_MODEL'
        )
        ON DUPLICATE KEY UPDATE
            status = VALUES(status),
            reason = VALUES(reason),
            analyzed_at = VALUES(analyzed_at),
            updated_at = NOW()
    </insert>

    <insert id="insertAnalysisSummary">
        INSERT INTO ai_analysis_summary (
            video_id,
            youtube_video_id,
            youtube_channel_id,
            neutral_count,
            filtered_count,
            suggestion_count,
            risk_summary,
            analysis_timestamp
        ) VALUES (
            #{videoId},
            #{youtubeVideoId},
            #{youtubeChannelId},
            #{neutralCount},
            #{filteredCount},
            #{suggestionCount},
            #{riskSummary},
            <choose>
                <when test="analysisTimestamp != null">
                    STR_TO_DATE(#{analysisTimestamp}, '%Y-%m-%dT%H:%i:%s.%f')
                </when>
                <otherwise>
                    NOW()
                </otherwise>
            </choose>
        )
        ON DUPLICATE KEY UPDATE
            neutral_count = VALUES(neutral_count),
            filtered_count = VALUES(filtered_count),
            suggestion_count = VALUES(suggestion_count),
            risk_summary = VALUES(risk_summary),
            analysis_timestamp = VALUES(analysis_timestamp),
            updated_at = NOW()
    </insert>

</mapper>

