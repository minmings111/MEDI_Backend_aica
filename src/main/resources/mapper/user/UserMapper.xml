<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" 
    "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.medi.backend.user.mapper.UserMapper">
        <!-- 전체 사용자 조회 디버깅용-->
    <select id="selectAllUsers" resultType="com.medi.backend.user.dto.UserDTO">
        SELECT 
            id,
            email,
            name,
            phone,
            is_terms_agreed,
            role,
            DATE_FORMAT(created_at, '%Y-%m-%d %H:%i:%s') as createdAt,
            DATE_FORMAT(updated_at, '%Y-%m-%d %H:%i:%s') as updatedAt
        FROM users
        ORDER BY id DESC
    </select>

        <!-- ResultMap: DB 컬럼명 → DTO 필드명 매핑 -->
    <resultMap id="UserResultMap" type="com.medi.backend.user.dto.UserDTO">
        <id property="id" column="id"/>
        <result property="email" column="email"/>
        <result property="password" column="password"/>
        <result property="name" column="name"/>
        <result property="phone" column="phone"/>
        <result property="isTermsAgreed" column="is_terms_agreed"/>
        <result property="role" column="role"/>
        <result property="createdAt" column="created_at"/>
        <result property="updatedAt" column="updated_at"/>
        <result property="provider" column="provider"/>
        <result property="providerId" column="provider_id"/>
        <result property="profileImage" column="profile_image"/>
    </resultMap>
    
    <!-- 이메일로 사용자 조회 -->
    <select id="findByEmail" resultMap="UserResultMap">
        SELECT id, email, password, name, phone, is_terms_agreed, 
               role, created_at, updated_at, provider, provider_id, profile_image
        FROM users
        WHERE email = #{email}
    </select>
    
    <!-- 사용자 정보 저장 (회원가입) -->
    <insert id="insertUser" useGeneratedKeys="true" keyProperty="id">
        INSERT INTO users (email, password, name, phone, is_terms_agreed, role)
        VALUES (#{email}, #{password}, #{name}, #{phone}, #{isTermsAgreed}, #{role})
    </insert>
    
    <!-- 이메일 존재 여부 확인 -->
    <select id="existsByEmail" resultType="int">
        SELECT COUNT(*) FROM users WHERE email = #{email}
    </select>
    
    <!-- 회원탈퇴 (사용자 삭제) -->
    <delete id="deleteUser">
        DELETE FROM users WHERE email = #{email}
    </delete>
    
    <!-- 비밀번호 업데이트 (비밀번호 재설정) -->
    <update id="updatePassword">
        UPDATE users 
        SET password = #{password}, updated_at = NOW()
        WHERE email = #{email}
    </update>
    
    <!-- ===== OAuth2 관련 쿼리 ===== -->
    
    <!-- Provider와 Provider ID로 사용자 조회 -->
    <select id="findByProviderAndProviderId" resultMap="UserResultMap">
        SELECT id, email, password, name, phone, is_terms_agreed, 
               role, created_at, updated_at, provider, provider_id, profile_image
        FROM users
        WHERE provider = #{provider} 
        AND provider_id = #{providerId}
    </select>
    
    <!-- OAuth2 사용자 정보 저장 (자동 회원가입) -->
    <insert id="insertOAuth2User" useGeneratedKeys="true" keyProperty="id">
        INSERT INTO users (
            email, password, name, phone, is_terms_agreed, role,
            provider, provider_id, profile_image
        ) VALUES (
            #{email}, #{password}, #{name}, #{phone}, #{isTermsAgreed}, #{role},
            #{provider}, #{providerId}, #{profileImage}
        )
    </insert>
    
    <!-- 사용자 ID로 사용자 조회 -->
    <select id="findById" resultMap="UserResultMap">
        SELECT id, email, password, name, phone, is_terms_agreed, 
               role, created_at, updated_at, provider, provider_id, profile_image
        FROM users
        WHERE id = #{id}
    </select>

</mapper>
