<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.medi.backend.youtube.mapper.YouTubeOAuthTokenMapper">

    <resultMap id="TokenResultMap" type="com.medi.backend.youtube.dto.YouTubeOAuthTokenDTO">
        <id property="id" column="id"/>
        <result property="userId" column="user_id"/>
        <result property="googleEmail" column="google_email"/>
        <result property="accessToken" column="access_token"/>
        <result property="refreshToken" column="refresh_token"/>
        <result property="accessTokenExpiresAt" column="access_token_expires_at"/>
        <result property="tokenStatus" column="token_status"/>
        <result property="createdAt" column="created_at"/>
        <result property="updatedAt" column="updated_at"/>
        <result property="lastUsedAt" column="last_used_at"/>
        <result property="lastRefreshedAt" column="last_refreshed_at"/>
    </resultMap>

    <insert id="upsert" parameterType="com.medi.backend.youtube.dto.YouTubeOAuthTokenDTO">
        INSERT INTO youtube_oauth_tokens(
            user_id, google_email, access_token, refresh_token,
            access_token_expires_at, token_status, created_at
        ) VALUES (
            #{userId}, #{googleEmail}, #{accessToken}, #{refreshToken},
            #{accessTokenExpiresAt}, #{tokenStatus}, NOW()
        )
        ON DUPLICATE KEY UPDATE
            access_token = VALUES(access_token),
            refresh_token = VALUES(refresh_token),
            access_token_expires_at = VALUES(access_token_expires_at),
            token_status = VALUES(token_status),
            updated_at = NOW()
    </insert>

    <select id="findByUserId" parameterType="int" resultMap="TokenResultMap">
        SELECT * FROM youtube_oauth_tokens
        WHERE user_id = #{userId}
        ORDER BY created_at DESC
        LIMIT 1
    </select>

    <select id="findByUserIdAndEmail" resultMap="TokenResultMap">
        SELECT * FROM youtube_oauth_tokens
        WHERE user_id = #{userId}
          AND google_email = #{googleEmail}
        ORDER BY created_at DESC
        LIMIT 1
    </select>

    <update id="updateTokenStatus">
        UPDATE youtube_oauth_tokens
        SET token_status = #{status}, updated_at = NOW()
        WHERE id = #{id}
    </update>

    <update id="updateUsageTimestamps">
        UPDATE youtube_oauth_tokens
        SET last_used_at = #{lastUsedAt}, last_refreshed_at = #{lastRefreshedAt}, updated_at = NOW()
        WHERE id = #{id}
    </update>

</mapper>


