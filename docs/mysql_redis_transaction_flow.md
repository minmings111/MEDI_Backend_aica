# MySQL â†’ Redis ìºì‹œ ë™ê¸°í™” í”Œë¡œìš°

## ğŸ“Œ ë¬¸ì œì  (ê¸°ì¡´ ì½”ë“œ)

### âŒ ê¸°ì¡´ ë°©ì‹ (ìœ„í—˜)
```java
// ë¬¸ì œ: MySQL ì»¤ë°‹ ì „ì— Redis ì €ì¥
channelMapper.upsert(dto);  // MySQL ì €ì¥ (ì•„ì§ ì»¤ë°‹ ì•ˆ ë¨)
redisTemplate.opsForValue().set(...);  // Redis ì €ì¥ (ë°”ë¡œ ì‹¤í–‰)

// ì‹œë‚˜ë¦¬ì˜¤:
// 1. MySQL ì €ì¥ ì„±ê³µ
// 2. Redis ì €ì¥ ì„±ê³µ
// 3. MySQL ë¡¤ë°± ë°œìƒ â†’ âŒ ë°ì´í„° ë¶ˆì¼ì¹˜!
//    - MySQL: ë°ì´í„° ì—†ìŒ
//    - Redis: ë°ì´í„° ìˆìŒ
```

### âœ… ê°œì„ ëœ ë°©ì‹ (`@TransactionalEventListener`)

```java
// 1. MySQL ì €ì¥ (íŠ¸ëœì­ì…˜ ë‚´)
channelMapper.upsert(dto);

// 2. ì´ë²¤íŠ¸ ë°œí–‰ (ì»¤ë°‹ ì „ì—ëŠ” íì—ë§Œ ì €ì¥)
eventPublisher.publishEvent(event);

// 3. MySQL ì»¤ë°‹ ì„±ê³µ
// 4. @TransactionalEventListenerê°€ ì´ë²¤íŠ¸ ì²˜ë¦¬
// 5. Redis ì €ì¥ ì‹¤í–‰
```

## ğŸ”„ ì „ì²´ í”Œë¡œìš°

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 1. Service ë©”ì„œë“œ ì‹¤í–‰ (@Transactional)                     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

YoutubeService.syncChannels()
    â†“
channelMapper.upsert(dto)  // MySQL ì €ì¥ (íŠ¸ëœì­ì…˜ ë‚´)
    â†“
eventPublisher.publishEvent(event)  // ì´ë²¤íŠ¸ ë°œí–‰ (íì— ì €ì¥)
    â†“
ë©”ì„œë“œ ì¢…ë£Œ â†’ íŠ¸ëœì­ì…˜ ì»¤ë°‹ ì‹œë„


â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 2. MySQL íŠ¸ëœì­ì…˜ ì»¤ë°‹                                       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

ì»¤ë°‹ ì„±ê³µ âœ…
    â†“
ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ì‹¤í–‰ íŠ¸ë¦¬ê±°
    â†“
ì»¤ë°‹ ì‹¤íŒ¨ âŒ
    â†“
ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ì‹¤í–‰ ì•ˆ ë¨ (ë°ì´í„° ì¼ê´€ì„± ë³´ì¥!)


â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 3. @TransactionalEventListener ì‹¤í–‰                         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

@TransactionalEventListener(phase = AFTER_COMMIT)
    â†“
CacheEventListener.handleChannelCacheEvent()
    â†“
redisTemplate.opsForValue().set(...)  // Redis ì €ì¥
    â†“
ë°ì´í„° ì¼ê´€ì„± ë³´ì¥! âœ…
```

## ğŸ“ ì½”ë“œ êµ¬ì¡°

### 1. ì´ë²¤íŠ¸ í´ë˜ìŠ¤

```java
// ChannelCacheEvent.java
public class ChannelCacheEvent {
    private final String youtubeChannelId;
    private final String channelName;
    // ...
}
```

### 2. ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ

```java
// CacheEventListener.java
@Component
public class CacheEventListener {
    
    @TransactionalEventListener(phase = TransactionPhase.AFTER_COMMIT)
    public void handleChannelCacheEvent(ChannelCacheEvent event) {
        // MySQL ì»¤ë°‹ ì„±ê³µ í›„ì—ë§Œ ì‹¤í–‰ë¨
        redisTemplate.opsForValue().set(...);
    }
}
```

### 3. Service ë©”ì„œë“œ

```java
// YoutubeService.java
@Transactional
public List<YoutubeChannelDto> syncChannels(Integer userId) {
    // 1. MySQL ì €ì¥
    channelMapper.upsert(dto);
    
    // 2. ì´ë²¤íŠ¸ ë°œí–‰ (ì»¤ë°‹ í›„ ì²˜ë¦¬)
    eventPublisher.publishEvent(event);
    
    return out;
}
```

## âš™ï¸ @TransactionalEventListener ì˜µì…˜

### TransactionPhase ì˜µì…˜

| Phase | ì‹¤í–‰ ì‹œì  | ì„¤ëª… |
|-------|----------|------|
| `BEFORE_COMMIT` | ì»¤ë°‹ ì „ | íŠ¸ëœì­ì…˜ì´ ì»¤ë°‹ë˜ê¸° ì§ì „ì— ì‹¤í–‰ |
| `AFTER_COMMIT` | **ì»¤ë°‹ í›„** | **íŠ¸ëœì­ì…˜ì´ ì„±ê³µì ìœ¼ë¡œ ì»¤ë°‹ëœ í›„ ì‹¤í–‰** (ê¶Œì¥) |
| `AFTER_ROLLBACK` | ë¡¤ë°± í›„ | íŠ¸ëœì­ì…˜ì´ ë¡¤ë°±ëœ í›„ ì‹¤í–‰ |
| `AFTER_COMPLETION` | ì™„ë£Œ í›„ | ì»¤ë°‹ ë˜ëŠ” ë¡¤ë°± ëª¨ë‘ ì™„ë£Œëœ í›„ ì‹¤í–‰ |

### í˜„ì¬ ì‚¬ìš© ì¤‘ì¸ ì˜µì…˜

```java
@TransactionalEventListener(phase = TransactionPhase.AFTER_COMMIT)
```

**ì™œ `AFTER_COMMIT`ì„ ì‚¬ìš©í•˜ëŠ”ê°€?**
- âœ… MySQL ì»¤ë°‹ì´ ì„±ê³µí•œ ê²½ìš°ì—ë§Œ Redis ì €ì¥
- âœ… MySQL ë¡¤ë°± ì‹œ Redis ì €ì¥ ì•ˆ ë¨ (ë°ì´í„° ì¼ê´€ì„±)
- âœ… MySQL ì»¤ë°‹ ì‹¤íŒ¨ ì‹œ Redisì— ì˜ëª»ëœ ë°ì´í„° ì €ì¥ ë°©ì§€

## ğŸ¯ ì¥ì 

### 1. ë°ì´í„° ì¼ê´€ì„± ë³´ì¥
- MySQL ì»¤ë°‹ ì„±ê³µ â†’ Redis ì €ì¥
- MySQL ë¡¤ë°± â†’ Redis ì €ì¥ ì•ˆ ë¨
- ë°ì´í„° ë¶ˆì¼ì¹˜ ë°©ì§€

### 2. ë¹„ë™ê¸° ì²˜ë¦¬ ê°€ëŠ¥
- MySQL ì»¤ë°‹ê³¼ Redis ì €ì¥ì´ ë¶„ë¦¬
- Redis ì €ì¥ ì‹¤íŒ¨í•´ë„ MySQLì€ ì´ë¯¸ ì»¤ë°‹ë¨
- í•„ìš”ì‹œ ì¬ì‹œë„ ë¡œì§ ì¶”ê°€ ê°€ëŠ¥

### 3. ì½”ë“œ ë¶„ë¦¬
- Service: ë¹„ì¦ˆë‹ˆìŠ¤ ë¡œì§ (MySQL ì €ì¥)
- Listener: ìºì‹œ ì—…ë°ì´íŠ¸ ë¡œì§ (Redis ì €ì¥)
- ê´€ì‹¬ì‚¬ ë¶„ë¦¬ (Separation of Concerns)

## âš ï¸ ì£¼ì˜ì‚¬í•­

### 1. Redis ì €ì¥ ì‹¤íŒ¨ ì²˜ë¦¬

```java
@TransactionalEventListener(phase = TransactionPhase.AFTER_COMMIT)
public void handleChannelCacheEvent(ChannelCacheEvent event) {
    try {
        redisTemplate.opsForValue().set(...);
    } catch (Exception e) {
        log.error("Redis ì €ì¥ ì‹¤íŒ¨", e);
        // MySQLì€ ì´ë¯¸ ì»¤ë°‹ë˜ì—ˆìœ¼ë¯€ë¡œ ì˜ˆì™¸ë¥¼ ë˜ì§€ì§€ ì•ŠìŒ
        // í•„ìš”ì‹œ ì¬ì‹œë„ ë¡œì§ ì¶”ê°€
    }
}
```

### 2. íŠ¸ëœì­ì…˜ ê²½ê³„

- `@Transactional`ì´ ìˆëŠ” ë©”ì„œë“œì—ì„œë§Œ ì´ë²¤íŠ¸ê°€ ì œëŒ€ë¡œ ë™ì‘
- íŠ¸ëœì­ì…˜ì´ ì—†ìœ¼ë©´ ì¦‰ì‹œ ì‹¤í–‰ë¨ (ì£¼ì˜!)

### 3. í…ŒìŠ¤íŠ¸

```java
// í…ŒìŠ¤íŠ¸ ì‹œ ì£¼ì˜: ì´ë²¤íŠ¸ëŠ” ì‹¤ì œë¡œ íŠ¸ëœì­ì…˜ ì»¤ë°‹ í›„ì— ì‹¤í–‰ë¨
@Test
@Transactional  // íŠ¸ëœì­ì…˜ ë‚´ì—ì„œ ì‹¤í–‰
public void testSyncChannels() {
    // í…ŒìŠ¤íŠ¸ ì½”ë“œ
    // ì‹¤ì œ ì»¤ë°‹ì€ @Rollback ë•Œë¬¸ì— ì•ˆ ë¨
    // ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆëŠ” ì‹¤í–‰ ì•ˆ ë¨
}
```

## ğŸ“Š ë¹„êµí‘œ

| ë°©ì‹ | ë°ì´í„° ì¼ê´€ì„± | ë³µì¡ë„ | ì„±ëŠ¥ |
|------|--------------|--------|------|
| **ê¸°ì¡´ (ë™ì‹œ ì €ì¥)** | âŒ ë¶ˆì¼ì¹˜ ê°€ëŠ¥ | âœ… ê°„ë‹¨ | âœ… ë¹ ë¦„ |
| **ì´ë²¤íŠ¸ ê¸°ë°˜** | âœ… ì¼ê´€ì„± ë³´ì¥ | âš ï¸ ì¤‘ê°„ | âœ… ë¹ ë¦„ |

## ğŸ”— ì°¸ê³ 

- Spring `@TransactionalEventListener` ê³µì‹ ë¬¸ì„œ
- MySQL íŠ¸ëœì­ì…˜ê³¼ Redis ìºì‹œ ë™ê¸°í™” íŒ¨í„´
- Write-Through vs Write-Behind ìºì‹œ íŒ¨í„´

