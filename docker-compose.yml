version: '3.8'

services:
  # MySQL 데이터베이스
  mysql:
    image: mysql:8.0
    container_name: medi-mysql
    environment:
      MYSQL_ROOT_PASSWORD: rootpassword
      MYSQL_DATABASE: medi
      MYSQL_USER: admin
      MYSQL_PASSWORD: 1234
    ports:
      - "3306:3306"
    volumes:
      - mysql_data:/var/lib/mysql
      - ./src/main/resources/db/migration:/docker-entrypoint-initdb.d
    networks:
      - medi-network
    healthcheck:
      test: [ "CMD", "mysqladmin", "ping", "-h", "localhost", "-u", "root", "-prootpassword" ]
      interval: 10s
      timeout: 5s
      retries: 5

  # Redis
  redis:
    image: redis:7-alpine
    container_name: medi-redis
    ports:
      - "6379:6379"
    volumes:
      - redis_data:/data
    networks:
      - medi-network
    healthcheck:
      test: [ "CMD", "redis-cli", "ping" ]
      interval: 10s
      timeout: 3s
      retries: 5

  # Backend Application (개발 환경에서는 로컬에서 직접 실행하므로 비활성화)
  # backend:
  #   build:
  #     context: .
  #     dockerfile: Dockerfile
  #   container_name: medi-backend
  #   ports:
  #     - "8080:8080"
  #
  #   # 메모리 및 CPU 제한 (서버 안정성 개선)
  #   mem_limit: 2500m # 최대 2.5GB
  #   mem_reservation: 512m # 최소 512MB 보장
  #   memswap_limit: 2500m # Swap 사용 금지 (성능 저하 방지)
  #   cpus: '2.0' # 2 코어
  #
  #   # 볼륨 마운트 (힙 덤프 및 GC 로그 저장용)
  #   volumes:
  #     - ./logs:/app/logs
  #
  #   environment:
  #     SPRING_PROFILES_ACTIVE: prod
  #     SPRING_DATASOURCE_URL: jdbc:mysql://mysql:3306/medi?serverTimezone=Asia/Seoul&characterEncoding=utf8
  #     SPRING_DATASOURCE_USERNAME: admin
  #     SPRING_DATASOURCE_PASSWORD: 1234
  #     SPRING_DATA_REDIS_HOST: redis
  #     SPRING_DATA_REDIS_PORT: 6379
  #     # JVM 메모리 및 GC 설정 (Dockerfile ENV 오버라이드)
  #     JAVA_OPTS: "-Xms1500m -Xmx1500m -XX:+UseG1GC -XX:MaxGCPauseMillis=200 -XX:+HeapDumpOnOutOfMemoryError -XX:HeapDumpPath=/app/logs/heapdump.hprof"
  #
  #   depends_on:
  #     mysql:
  #       condition: service_healthy
  #     redis:
  #       condition: service_healthy
  #   networks:
  #     - medi-network
  #   restart: unless-stopped

volumes:
  mysql_data:
  redis_data:


networks:
  medi-network:
    driver: bridge
